<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mapa Sprzedaży - Powiaty</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
      background: #f0f0f0;
    }

    /* Styl dla etykiet powiatów */
    .county-label {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #333;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      pointer-events: none;
    }

    /* Legenda dostosowana do mobile */
    .legend {
      background: white;
      padding: 12px;
      line-height: 24px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      max-width: 200px;
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 10px;
      border-radius: 3px;
    }

    /* Optymalizacja Pop-upów na telefonach */
    .leaflet-popup-content {
      font-size: 14px;
      line-height: 1.6;
    }

    /* Ukrywanie legendy na bardzo małych ekranach (opcjonalnie) */
    @media (max-width: 600px) {
      .legend {
        font-size: 12px;
        padding: 8px;
        line-height: 18px;
      }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeWsr5Gpjk0ZpcHPdQr_95TKZaNVEjwPXT523dzFV7U6NzC1YpbXhG89zO1j6VICHqiS45tkZ6XEr3/pub?output=csv';
    const GEOJSON_FILE = 'powiaty4205.geojson';

    // Inicjalizacja mapy z blokadą scrolla (lepiej dla mobile)
    const map = L.map('map', { 
      preferCanvas: true,
      scrollWheelZoom: false, // Zapobiega przypadkowemu zoomowaniu podczas przewijania strony
      tap: true // Obsługa dotyku
    }).setView([52.06, 19.48], window.innerWidth < 600 ? 5 : 6);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OSM'
    }).addTo(map);

    function getColor(seller) {
      const s = seller ? seller.trim().toLowerCase() : '';
      switch (s) {
        case 'aleksander': return '#3498db';
        case 'dominik':    return '#2ecc71';
        case 'michał':     return '#f1c40f';
        case 'dawid':      return '#e74c3c';
        case 's':          return '#e67e22';
        default:           return '#bdc3c7';
      }
    }

    function cleanName(name) {
      if (!name) return "";
      return name.toString().toLowerCase().replace("powiat", "").replace("miasto", "").trim();
    }

    async function loadProject() {
      try {
        const [csvResponse, geoResponse] = await Promise.all([
          fetch(SHEET_URL),
          fetch(GEOJSON_FILE)
        ]);

        const csvText = await csvResponse.text();
        const powiatyData = await geoResponse.json();

        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
        const dataMap = {};
        parsed.forEach(row => {
          if (row.Nazwa) dataMap[cleanName(row.Nazwa)] = row.Sprzedawca;
        });

        const geoLayer = L.geoJson(powiatyData, {
          style: function (feature) {
            const props = feature.properties;
            const rawName = props.nazwa || props.Nazwa || props.name || "";
            const seller = dataMap[cleanName(rawName)];
            return {
              fillColor: getColor(seller),
              weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7
            };
          },
          onEachFeature: function (feature, layer) {
            const props = feature.properties;
            const rawName = props.nazwa || props.Nazwa || props.name || "Nieznany";
            const seller = dataMap[cleanName(rawName)] || "Brak danych";

            layer.bindPopup(`<strong>Powiat:</strong> ${rawName}<br><strong>Opiekun:</strong> ${seller}`);
            
            // Reakcja na kliknięcie (zamiast hover, który nie działa na mobile)
            layer.on('click', function () {
              this.setStyle({ fillOpacity: 0.9, weight: 3 });
              this.openPopup();
            });
          }
        }).addTo(map);

        // Legenda
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
          const div = L.DomUtil.create('div', 'legend');
          const sellers = ['Dominik', 'Michał', 'Aleksander', 'Dawid', 'S'];
          div.innerHTML = '<strong>Opiekunowie:</strong><br>';
          sellers.forEach(s => {
            div.innerHTML += `<i style="background:${getColor(s)}"></i> ${s}<br>`;
          });
          div.innerHTML += `<i style="background:${getColor('')}"></i> Brak`;
          return div;
        };
        legend.addTo(map);

      } catch (e) {
        console.error("Błąd:", e);
      }
    }

    loadProject();
  </script>
</body>
</html>
