<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa Sprzedaży - Powiaty</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
      background: #f0f0f0;
    }

    .county-label {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #333;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      pointer-events: none;
    }

    .legend {
      background: white;
      padding: 10px;
      line-height: 20px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .legend i {
      width: 16px;
      height: 16px;
      float: left;
      margin-right: 8px;
      border-radius: 2px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeWsr5Gpjk0ZpcHPdQr_95TKZaNVEjwPXT523dzFV7U6NzC1YpbXhG89zO1j6VICHqiS45tkZ6XEr3/pub?output=csv';
    const GEOJSON_FILE = 'powiaty4205.geojson'; // Plik musi być w tym samym folderze

    const map = L.map('map', { preferCanvas: true }).setView([52.06, 19.48], 6);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    function getColor(seller) {
      // Zamieniamy wszystko na małe litery, żeby uniknąć problemów z wielkością znaków
      const s = seller ? seller.trim().toLowerCase() : '';

      switch (s) {
        case 'aleksander': return '#3498db';
        case 'dominik': return '#2ecc71';
        case 'michał': return '#f1c40f';
        case 's': return '#e74c3c';
        default: return '#bdc3c7'; // Szary dla braku danych
      }
    }

    function cleanName(name) {
      if (!name) return "";
      return name.toString().toLowerCase().replace("powiat", "").replace("miasto", "").trim();
    }

    async function loadProject() {
      try {
        // 1. Pobieranie danych z Google Sheets i GeoJSON równolegle
        const [csvResponse, geoResponse] = await Promise.all([
          fetch(SHEET_URL),
          fetch(GEOJSON_FILE)
        ]);

        const csvText = await csvResponse.text();
        const powiatyData = await geoResponse.json();

        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
        const dataMap = {};
        parsed.forEach(row => {
          if (row.Nazwa) dataMap[cleanName(row.Nazwa)] = row.Sprzedawca;
        });

        // 2. Renderowanie warstwy
        const geoLayer = L.geoJson(powiatyData, {
          style: function (feature) {
            const props = feature.properties;
            const rawName = props.nazwa || props.Nazwa || props.name || "";
            const seller = dataMap[cleanName(rawName)];
            return {
              fillColor: getColor(seller),
              weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7
            };
          },
          onEachFeature: function (feature, layer) {
            const props = feature.properties;
            const rawName = props.nazwa || props.Nazwa || props.name || "Nieznany";
            const seller = dataMap[cleanName(rawName)] || "Brak danych";

            layer.bindPopup(`<b>Powiat:</b> ${rawName}<br><b>Sprzedawca:</b> ${seller}`);
            layer.bindTooltip(`${rawName}`, { permanent: false, direction: 'center', className: 'county-label' });

            layer.on('mouseover', function () { this.setStyle({ fillOpacity: 0.9, weight: 2 }); });
            layer.on('mouseout', function () { geoLayer.resetStyle(this); });
          }
        }).addTo(map);

        // Obsługa Tooltipów przy zoomie
        map.on('zoomend', () => {
          const z = map.getZoom();
          geoLayer.eachLayer(l => z >= 11 ? l.openTooltip() : l.closeTooltip());
        });

        // Legenda
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
          const div = L.DomUtil.create('div', 'legend');
          const sellers = ['Dominik', 'Michał', 'Aleksander', 'S'];
          div.innerHTML = '<strong>Opiekunowie:</strong><br>';
          sellers.forEach(s => {
            div.innerHTML += `<i style="background:${getColor(s)}"></i> Sprzedawca ${s}<br>`;
          });
          div.innerHTML += `<i style="background:${getColor('')}"></i> Brak danych`;
          return div;
        };
        legend.addTo(map);

      } catch (e) {
        console.error("Błąd ładowania danych:", e);
        alert("Wystąpił błąd podczas ładowania mapy. Upewnij się, że plik GeoJSON jest w tym samym folderze co HTML.");
      }
    }

    loadProject();
  </script>
</body>

</html>