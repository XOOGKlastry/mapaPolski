<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mapa Sprzedaży - Pełne Dane</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { height: 100vh; width: 100%; background: #f0f0f0; }
    
    .legend {
      background: white; padding: 12px; line-height: 24px;
      border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.2);
      max-height: 80vh; overflow-y: auto;
    }
    .legend i { width: 18px; height: 18px; float: left; margin-right: 10px; border-radius: 3px; border: 1px solid #ccc; }

    .custom-popup b { color: #2c3e50; text-transform: uppercase; font-size: 10px; display: block; margin-top: 5px; }
    .custom-popup span { font-size: 14px; color: #34495e; display: block; margin-bottom: 2px; }
    .popup-title { font-size: 16px !important; font-weight: bold; border-bottom: 2px solid #eee; margin-bottom: 10px !important; padding-bottom: 5px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeWsr5Gpjk0ZpcHPdQr_95TKZaNVEjwPXT523dzFV7U6NzC1YpbXhG89zO1j6VICHqiS45tkZ6XEr3/pub?output=csv';
    const GEOJSON_FILE = 'powiaty4205.geojson';

    // KONFIGURACJA MAPY - NAPRAWIONY SCROLL
    const map = L.map('map', { 
      preferCanvas: true,
      scrollWheelZoom: true, // Włączone przybliżanie kółkiem
      wheelDebounceTime: 50, // Szybsza reakcja na kółko
      dragging: true,        // Włączone przesuwanie
      tap: false             // Wyłączone 'tap' (rozwiązuje problemy na iOS/Chrome)
    }).setView([52.06, 19.48], 6);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OSM'
    }).addTo(map);

    // Dynamiczne kolory dla legendy
    const colors = ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#e67e22', '#9b59b6', '#1abc9c', '#d35400', '#27ae60'];
    const colorMap = {};

    function getColor(seller) {
      if (!seller || seller.trim() === "") return '#bdc3c7';
      const s = seller.toString().trim();
      if (!colorMap[s]) {
        const idx = Object.keys(colorMap).length;
        colorMap[s] = colors[idx % colors.length];
      }
      return colorMap[s];
    }

    function cleanName(name) {
      if (!name) return "";
      return name.toString().toLowerCase().replace("powiat", "").replace("miasto", "").trim();
    }

    async function loadProject() {
      try {
        const [csvResponse, geoResponse] = await Promise.all([
          fetch(SHEET_URL),
          fetch(GEOJSON_FILE)
        ]);

        const csvText = await csvResponse.text();
        const powiatyData = await geoResponse.json();
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
        
        const dataMap = {};
        const uniqueSellers = new Set();

        parsed.forEach(row => {
          if (row.Nazwa) {
            dataMap[cleanName(row.Nazwa)] = row;
            if (row.Sprzedawca && row.Sprzedawca.trim() !== "") {
              uniqueSellers.add(row.Sprzedawca.trim());
            }
          }
        });

        const geoLayer = L.geoJson(powiatyData, {
          style: function (feature) {
            const row = dataMap[cleanName(feature.properties.nazwa || feature.properties.Nazwa)];
            const seller = row ? row.Sprzedawca : '';
            return {
              fillColor: getColor(seller),
              weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7
            };
          },
          onEachFeature: function (feature, layer) {
            const rawName = feature.properties.nazwa || feature.properties.Nazwa || "Nieznany";
            const row = dataMap[cleanName(rawName)];

            let popupContent = `<div class="custom-popup"><span class="popup-title">${rawName}</span>`;
            if (row) {
              Object.keys(row).forEach(key => {
                if (key.toLowerCase() !== 'nazwa' && row[key]) {
                  popupContent += `<b>${key}:</b><span>${row[key]}</span>`;
                }
              });
            } else {
              popupContent += `<span>Brak danych w arkuszu.</span>`;
            }
            popupContent += `</div>`;

            layer.bindPopup(popupContent);
            layer.on('click', function (e) {
              this.setStyle({ fillOpacity: 0.9, weight: 3 });
              this.openPopup();
              L.DomEvent.stopPropagation(e); // Zapobiega dziwnym zachowaniom mapy przy kliku
            });

            layer.on('popupclose', function() {
              geoLayer.resetStyle(this);
            });
          }
        }).addTo(map);

        // Automatyczne dopasowanie widoku
        map.fitBounds(geoLayer.getBounds());

        // --- DYNAMICZNA LEGENDA ---
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML = '<strong>Sprzedawcy:</strong><br>';
          
          const sortedSellers = Array.from(uniqueSellers).sort();
          sortedSellers.forEach(s => {
            div.innerHTML += `<div><i style="background:${getColor(s)}"></i> ${s}</div>`;
          });
          div.innerHTML += `<div><i style="background:${getColor('')}"></i> Pozostałe</div>`;
          return div;
        };
        legend.addTo(map);

      } catch (e) {
        console.error("Błąd:", e);
      }
    }

    loadProject();
</script>
</body>
</html>

